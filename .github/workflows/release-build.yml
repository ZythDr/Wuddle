name: Build Release Artifacts

on:
  workflow_dispatch:
  push:
    branches:
      - "v2-dev"
    tags:
      - "v*"

jobs:
  build-linux:
    name: Linux Bundles
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: wuddle-gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: wuddle-gui/package-lock.json

      - name: Sync App Version From Tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: node ./scripts/sync-version.mjs "${{ github.ref_name }}"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            wuddle-gui/src-tauri -> target
            wuddle-launcher -> target

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            squashfs-tools

      - name: Install JS Dependencies
        run: npm ci

      - name: Generate App Icons
        run: npm run icon

      - name: Build Linux Bundles
        env:
          NO_STRIP: "1"
        run: npx tauri build --bundles appimage,deb,rpm

      - name: Prepare Linux Portable tar.gz
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-dev-${GITHUB_RUN_NUMBER}}"
          TAG="${TAG//\//-}"
          PORTABLE_NAME="wuddle-${TAG}-linux-portable.tar.gz"
          rm -rf portable-linux
          mkdir -p portable-linux
          cp src-tauri/target/release/wuddle-gui portable-linux/wuddle-bin
          chmod +x portable-linux/wuddle-bin
          cat > portable-linux/wuddle <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          SELF_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
          BIN="${SELF_DIR}/wuddle-bin"

          if [[ ! -x "${BIN}" ]]; then
            echo "ERROR: Missing executable ${BIN}" >&2
            exit 1
          fi

          run_x11() {
            exec env GDK_BACKEND=x11 WINIT_UNIX_BACKEND=x11 WEBKIT_DISABLE_DMABUF_RENDERER=1 "${BIN}" "$@"
          }

          if [[ "${WUDDLE_FORCE_X11:-0}" == "1" ]]; then
            run_x11 "$@"
          fi

          if [[ "${XDG_SESSION_TYPE:-}" == "wayland" || -n "${WAYLAND_DISPLAY:-}" ]]; then
            set +e
            env GDK_BACKEND=wayland "${BIN}" "$@"
            status=$?
            set -e

            if [[ "${status}" -eq 0 || "${status}" -eq 130 || "${status}" -eq 143 ]]; then
              exit "${status}"
            fi

            echo "Wuddle: Wayland launch failed (exit ${status}); retrying with X11 compatibility mode..." >&2
            run_x11 "$@"
          fi

          exec "${BIN}" "$@"
          EOF
          chmod +x portable-linux/wuddle
          cat > portable-linux/README-LINUX.txt <<'EOF'
          Wuddle Linux Portable
          =====================

          Run:
            ./wuddle

          Notes:
          - This is a plain portable binary package (not AppImage).
          - The launcher auto-tries Wayland and falls back to X11 compatibility mode.
          - You can force X11 mode with: WUDDLE_FORCE_X11=1 ./wuddle
          - App data uses the default user data directory unless you enable portable mode.
          EOF
          tar -C portable-linux -czf "${PORTABLE_NAME}" .

      - name: Upload Linux Bundle Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wuddle-linux-bundles
          path: |
            wuddle-gui/src-tauri/target/release/bundle/appimage/*.AppImage
            wuddle-gui/src-tauri/target/release/bundle/deb/*.deb
            wuddle-gui/src-tauri/target/release/bundle/rpm/*.rpm
            wuddle-gui/wuddle-*-linux-portable.tar.gz
          if-no-files-found: error

  build-windows:
    name: Windows Portable
    runs-on: windows-latest
    defaults:
      run:
        working-directory: wuddle-gui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: wuddle-gui/package-lock.json

      - name: Sync App Version From Tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: node ./scripts/sync-version.mjs "${{ github.ref_name }}"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust Artifacts
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            wuddle-gui/src-tauri -> target
            wuddle-launcher -> target

      - name: Install JS Dependencies
        run: npm ci

      - name: Generate App Icons
        run: npm run icon

      - name: Build Windows Executable (no installer)
        run: npx tauri build --no-bundle

      - name: Build Windows Launcher
        run: cargo build --manifest-path ../wuddle-launcher/Cargo.toml --release

      - name: Prepare Portable ZIP
        shell: pwsh
        run: |
          $tag = if ($env:GITHUB_REF_NAME) { $env:GITHUB_REF_NAME } else { "dev-$($env:GITHUB_RUN_NUMBER)" }
          $tag = $tag -replace '/', '-'
          $portableZip = "wuddle-$tag-windows-portable.zip"
          $portableDir = "portable"
          $versionDir = "$portableDir/versions/$tag"
          New-Item -ItemType Directory -Path $portableDir -Force | Out-Null
          New-Item -ItemType Directory -Path $versionDir -Force | Out-Null
          Copy-Item "../wuddle-launcher/target/release/wuddle-launcher.exe" "$portableDir/Wuddle.exe" -Force
          Copy-Item "src-tauri/target/release/wuddle-gui.exe" "$versionDir/Wuddle-bin.exe" -Force
          @{ current = $tag } | ConvertTo-Json | Set-Content "$portableDir/current.json"
          @"
          Wuddle (Windows ZIP)
          ====================

          - Run Wuddle.exe (launcher)
          - The launcher reads current.json and starts versions/<current>/Wuddle-bin.exe
          - New releases can be unpacked into this same folder; the launcher stays stable.
          - App data is stored in your normal user data directory (AppData/Roaming/wuddle)
          - Optional: create a file named wuddle-portable.flag next to Wuddle.exe to force portable mode.
          - In portable mode, app data is stored next to the exe in ./wuddle-data
          - GitHub token is session-only in portable mode (not stored in system keychain)
          "@ | Set-Content "$portableDir/README-PORTABLE.txt"
          Compress-Archive -Path "$portableDir/*" -DestinationPath $portableZip -Force

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wuddle-windows-portable
          path: wuddle-gui/wuddle-*-windows-portable.zip
          if-no-files-found: error

  release:
    name: Publish GitHub Release (stable + pre-release)
    needs: [build-linux, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout (for changelog summary)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Classify tag (main=stable, v2-dev=pre-release)
        id: tag_guard
        run: |
          set -euo pipefail
          git fetch --no-tags origin +refs/heads/main:refs/remotes/origin/main
          git fetch --no-tags origin +refs/heads/v2-dev:refs/remotes/origin/v2-dev || true
          TAG_SHA="$(git rev-list -n 1 "${GITHUB_REF_NAME}")"

          if git merge-base --is-ancestor "${TAG_SHA}" origin/main; then
            echo "publish=true" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "channel=stable" >> "$GITHUB_OUTPUT"
            echo "Tag ${GITHUB_REF_NAME} is on main; publishing stable release."
          elif git show-ref --verify --quiet refs/remotes/origin/v2-dev && git merge-base --is-ancestor "${TAG_SHA}" origin/v2-dev; then
            echo "publish=true" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
            echo "channel=prerelease" >> "$GITHUB_OUTPUT"
            echo "Tag ${GITHUB_REF_NAME} is on v2-dev; publishing pre-release."
          else
            echo "publish=false" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "channel=skip" >> "$GITHUB_OUTPUT"
            echo "Tag ${GITHUB_REF_NAME} is not on main or v2-dev; skipping release publish."
          fi

      - name: Download Linux Artifacts
        if: steps.tag_guard.outputs.publish == 'true'
        uses: actions/download-artifact@v4
        with:
          name: wuddle-linux-bundles
          path: dist/linux

      - name: Download Windows Artifact
        if: steps.tag_guard.outputs.publish == 'true'
        uses: actions/download-artifact@v4
        with:
          name: wuddle-windows-portable
          path: dist/windows

      - name: Build Release Summary
        if: steps.tag_guard.outputs.publish == 'true'
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          NOTES_FILE="dist/RELEASE_BODY.md"

          {
            echo "## What's New"
            echo
            if [ -n "${PREV_TAG}" ]; then
              git log --no-merges --pretty='- %s' "${PREV_TAG}..${TAG}" | head -n 20
              echo
              echo "_Changes since ${PREV_TAG}_"
            else
              git log --no-merges --pretty='- %s' -n 20
              echo
              echo "_Initial release summary_"
            fi
            echo
            echo "---"
            echo
            echo "## Downloads"
            echo
            echo "- Linux: AppImage, .deb, .rpm, portable tar.gz"
            echo "- Windows: Portable ZIP"
            echo
            echo "_Full autogenerated changelog is included below._"
          } > "${NOTES_FILE}"

      - name: Create GitHub Release
        if: steps.tag_guard.outputs.publish == 'true'
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ steps.tag_guard.outputs.prerelease }}
          body_path: dist/RELEASE_BODY.md
          generate_release_notes: true
          files: |
            dist/linux/**/*.AppImage
            dist/linux/**/*.deb
            dist/linux/**/*.rpm
            dist/linux/**/*.tar.gz
            dist/windows/**/*.zip
